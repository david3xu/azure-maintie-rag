# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Architecture Overview

This is an **Azure Universal RAG system** - a production-grade multi-agent platform combining knowledge graphs, vector search, and Graph Neural Networks (GNNs) for intelligent document processing.

### Core Architecture: Multi-Agent System (PydanticAI)

**Three specialized agents with real implementation:**
- **Domain Intelligence Agent** (`agents/domain_intelligence/agent.py` - 122 lines): Analyzes document domains and generates dynamic configurations
- **Knowledge Extraction Agent** (`agents/knowledge_extraction/agent.py` - 368 lines): Extracts entities and relationships with validation processors  
- **Universal Search Agent** (`agents/universal_search/agent.py` - 271 lines): Orchestrates tri-modal search (Vector + Graph + GNN)

### Key Architecture Principles

**Zero-Hardcoded-Values Philosophy**: All business logic parameters come from:
1. **Dynamic Configuration Manager** (`agents/core/dynamic_config_manager.py`)
2. **Learned Domain Configurations** (generated by Domain Intelligence Agent)
3. **Performance Feedback Loops** (adaptive based on query metrics)

**Multi-Agent Coordination**:
- **Agent Interfaces** (`agents/interfaces/agent_contracts.py`): Data-driven Pydantic contracts
- **Workflow Orchestration** (`agents/workflows/`): Graph-based coordination with state persistence
- **Azure Service Container** (`agents/core/azure_service_container.py`): Unified service access with DefaultAzureCredential

## Development Commands

### Essential Development Workflow
```bash
# Core development cycle
make setup              # Full project setup (backend + frontend)  
make dev                # Start backend API (8000) and frontend UI (5174)
make health             # Comprehensive service health check
make clean              # Clean sessions with log replacement

# Environment synchronization (critical for Azure services)
./scripts/sync-env.sh development    # Switch to development + sync backend
./scripts/sync-env.sh staging       # Switch to staging + sync backend  
make sync-env                       # Sync backend with current azd environment
```

### Data Processing Pipeline
```bash
# Full pipeline commands (use these for end-to-end workflow)
make data-prep-full     # Complete data processing pipeline
make data-upload        # Upload documents & create chunks
make knowledge-extract  # Extract entities & relationships
make query-demo         # Query pipeline demonstration
make unified-search-demo # Tri-modal search demonstration
```

### Testing Commands
```bash
# Testing strategy (tests use real Azure services)
pytest                  # All tests with automatic asyncio handling
pytest tests/unit/      # Unit tests for agent logic
pytest tests/integration/ # Integration tests with Azure services
pytest tests/azure_validation/ # Azure service health validation
pytest tests/performance/ # SLA compliance tests

# Useful testing patterns
pytest -v --tb=short    # Verbose output with short tracebacks
pytest -k "test_name"   # Run specific test pattern
pytest --collect-only   # Show available tests without running
```

### Individual Service Development
```bash
# Backend development
uvicorn api.main:app --reload --host 0.0.0.0 --port 8000

# Frontend development  
cd frontend/
npm run dev             # Start Vite dev server (localhost:5174)
npm run build           # Production build
npm run lint            # Run ESLint with TypeScript rules
npx tsc --noEmit        # TypeScript type checking without compilation
```

### Azure Deployment
```bash
azd up                  # Deploy complete Azure infrastructure
azd env select production && azd up  # Deploy to production environment
```

## Critical Development Guidelines

### Zero-Hardcoded-Values Architecture (CRITICAL)

**Never use hardcoded business logic values.** All parameters must come from:
1. **Dynamic Configuration Manager** (`agents/core/dynamic_config_manager.py`)
2. **Learned Domain Configurations** (generated by Domain Intelligence Agent)
3. **Performance Feedback Loops** (adaptive based on query metrics)

**Configuration Flow**: System Configuration → Domain Intelligence Agent → Dynamic Runtime Configuration

**Pre-commit Hook Enforcement**: The repository enforces zero-hardcoded-values via `scripts/hooks/pre-commit-anti-hardcoding.sh`:
- Detects hardcoded values that should be in `agents/core/constants.py`
- Identifies mathematical expressions for `agents/core/math_expressions.py`
- Validates centralized data model patterns in `agents/core/data_models.py`

### Agent Development Patterns (CRITICAL)

**Agents are stateless** and communicate through well-defined interfaces:
- **Use dependency injection** for Azure service access via `agents/core/azure_service_container.py`
- **Follow complexity graduation**: Simple agents → simple architecture
- **All agent interfaces use data-driven Pydantic models** (see `agents/interfaces/agent_contracts.py`)
- **Use centralized configuration** via `config/centralized_config.py` for dynamic settings

### Clean Architecture Enforcement
- **Layer Separation**: Agents depend on infrastructure, never the reverse
- **Dependency Injection**: Services injected into agents for testability
- **Error Handling**: Comprehensive Azure service retry logic and graceful degradation
- **Azure Authentication**: Always use `DefaultAzureCredential` for unified authentication

## Technology Stack

### Backend Architecture
- **Python 3.11+** with async/await patterns throughout
- **FastAPI** with uvicorn for API endpoints
- **PydanticAI** for multi-agent framework
- **Azure OpenAI** for LLM operations  
- **Azure Cognitive Search** for vector search (1536D vectors)
- **Azure Cosmos DB** (Gremlin API) for knowledge graphs
- **Azure ML** for GNN training and inference
- **PyTorch + torch-geometric** for graph neural networks

### Frontend Architecture
- **React 19.1.0** with TypeScript 5.8.3
- **Vite 7.0.4** for build tooling and development
- **Axios 1.10.0** for HTTP requests
- **Server-Sent Events** for real-time progress updates

### Code Quality & Testing
- **Black** formatter (line length 88, configured in pyproject.toml)
- **isort** for import organization (black profile, first-party packages configured)
- **ESLint** for TypeScript/React code quality
- **pytest** with asyncio auto mode and comprehensive test discovery
- **Pre-commit hooks** for zero-hardcoded-values enforcement
- **MyPy** for type checking

## Configuration & Environment Management

### Environment Configuration
- `config/environments/development.env` - Development Azure settings
- `config/environments/staging.env` - Staging Azure settings  
- `config/azure_settings.py` - Azure service settings with validation
- Root level: `pyproject.toml`, `pytest.ini` for project tooling

**Environment Synchronization**:
- Configuration automatically syncs with `azd` environment selection
- Use `./scripts/sync-env.sh <environment>` to switch and sync
- Environment variables managed through `USE_MANAGED_IDENTITY` setting

### Azure Service Authentication
- Uses **DefaultAzureCredential** for unified authentication across all services
- Supports managed identity (production) and CLI authentication (development)
- No API keys or connection strings in code - all through Azure authentication

## Testing & Validation Strategy

### Testing Architecture
- **Test Organization**: Tests organized by type - unit, integration, azure_validation, performance
- **Real Azure Services**: Tests use actual Azure services, not mocks (see `tests/conftest.py`)
- **Azure Validation**: Real Azure service health checks in `tests/azure_validation/`
- **Integration Tests**: Multi-service workflows with performance validation in `tests/integration/`
- **Test Results Storage**: Results stored in `test_results/` with timestamped JSON files

### Performance Monitoring
- **Target Metrics**: Sub-3-second query processing (currently 0.8-1.8s uncached)
- **Cache Performance**: 60% cache hit rate (reduces to ~50ms response time)
- **Extraction Accuracy**: 85% relationship extraction accuracy
- **Concurrent Users**: 100+ concurrent users supported

### Session Management Pattern
- Clean session replacement (no log accumulation)
- Unique session timestamps for tracking
- Performance metrics capture in `logs/performance.log`
- Azure status monitoring in `logs/azure_status.log`

## Code Quality & Validation

### Pre-commit Validation Workflow
```bash
# Run before committing (required)
black . --check                # Code formatting check
isort . --check-only           # Import organization check
cd frontend && npm run lint    # Frontend linting
pytest tests/unit/             # Quick unit tests
```

### Service Validation Commands
```bash
make health                    # Full system health check
make azure-status             # Azure infrastructure status
make session-report           # Current session metrics
```

## Key File Structure

### Core Architecture Components
```
agents/                          # Multi-agent system (PydanticAI)
├── core/                        # Core infrastructure (13 modules)
│   ├── azure_service_container.py  # Consolidated Azure services (471 lines)
│   ├── dynamic_config_manager.py   # Dynamic configuration
│   ├── data_models.py              # Centralized Pydantic models (1,536+ lines)
│   ├── constants.py                # Zero-hardcoded-values constants
│   ├── math_expressions.py         # Mathematical expressions
│   └── pydantic_ai_provider.py     # PydanticAI framework integration
├── domain_intelligence/         # Domain analysis agent
├── knowledge_extraction/        # Entity/relationship extraction agent
├── universal_search/            # Tri-modal search agent
├── workflows/                   # Agent coordination & state persistence
├── interfaces/                  # Data-driven Pydantic contracts
└── shared/                      # Common agent utilities (13 modules)
    ├── capability_patterns.py   # Agent capability patterns
    ├── config_enforcement.py    # Configuration validation
    ├── intelligent_config_provider.py # Smart configuration provisioning
    ├── workflow_state_bridge.py # State management bridge
    └── graph_communication.py   # Inter-agent communication

infrastructure/                  # Azure service clients
├── azure_openai/               # LLM operations and knowledge extraction
├── azure_search/               # Vector search integration
├── azure_cosmos/               # Graph database (Gremlin API)
├── azure_storage/              # Blob storage for documents
├── azure_ml/                   # ML models and GNN training
└── prompt_workflows/           # Jinja2 templates for prompt engineering

config/                         # Environment-based configuration
├── centralized_config.py       # Dynamic configuration management
├── azure_settings.py          # Azure service settings
└── environments/               # Environment-specific Azure settings (.env files)

tests/                          # Comprehensive testing strategy
├── unit/                       # Agent logic and configuration tests
├── integration/                # Multi-service integration tests
├── azure_validation/           # Azure service health validation
├── performance/                # Performance and SLA compliance tests
└── conftest.py                 # Real Azure services fixtures
```

## Current Development Context

### Active Branch: `fix/design-overlap-consolidation`
Focus on eliminating hardcoded values and consolidating agent boundaries.

### Development Priorities
1. **Zero Hardcoded Values**: All business logic parameters must come from Domain Intelligence Agent or dynamic configuration
2. **Agent Architecture**: Each agent has specific complexity requirements and clean boundaries
3. **Azure Service Integration**: Always use `DefaultAzureCredential`, implement comprehensive health checks
4. **Testing Against Real Services**: Test with actual Azure services, comprehensive validation
5. **Performance Optimization**: System learns and optimizes through performance correlation

### Key Constraints
- **Security**: Never commit secrets or API keys - use Azure Key Vault and DefaultAzureCredential
- **Architecture**: Agents depend on infrastructure, never the reverse
- **Configuration**: All parameters come from centralized configuration or learned domain configurations
- **Testing**: Use real Azure services, not mocks, for integration testing