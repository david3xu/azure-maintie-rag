# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Architecture Overview

This is an **Azure Universal RAG system** - a production-grade multi-agent platform combining knowledge graphs, vector search, and Graph Neural Networks (GNNs) for intelligent document processing with **zero hardcoded domain bias**.

### Core Architecture: Multi-Agent System (PydanticAI)

**Four specialized agents with real Azure integration:**
- **Domain Intelligence Agent** (`agents/domain_intelligence/agent.py`): Analyzes document domains and generates dynamic configurations using Azure OpenAI
- **Knowledge Extraction Agent** (`agents/knowledge_extraction/agent.py`): Extracts entities and relationships with Azure Cosmos DB Gremlin integration  
- **Universal Search Agent** (`agents/universal_search/agent.py`): Orchestrates tri-modal search (Vector + Graph + GNN) across Azure services
- **Query Generation Agents** (`agents/query_generation/`): Specialized SQL-pattern agents for Gremlin, search, and analysis queries

### Key Architecture Principles

**Zero-Hardcoded-Values Philosophy**: All business logic parameters come from:
1. **Universal Models** (`agents/core/universal_models.py`): Domain-agnostic data models
2. **Configuration Management** (`config/universal_config.py`, `agents/core/simple_config_manager.py`): Runtime configuration
3. **Learned Domain Configurations** (generated by Domain Intelligence Agent)
4. **Performance Feedback Loops** (adaptive based on query metrics)

**Universal RAG Philosophy**: 
- **Domain-Agnostic**: No predetermined domain categories or assumptions
- **Content Discovery**: System discovers domain characteristics from content analysis
- **Adaptive Configuration**: Parameters adjust based on measured content properties, not domain labels

**Multi-Agent Coordination**:
- **PydanticAI Framework**: Type-safe agent communication with validation
- **Azure Service Integration**: Real Azure OpenAI, Cosmos DB, Cognitive Search, and ML services
- **Query Generation Pattern**: SQL-style agent specialization for different query types

## Critical Development Guidelines

### Universal RAG Philosophy (CRITICAL)

**Never use hardcoded domain assumptions or business logic values.** All parameters must come from:
1. **Universal Models** (`agents/core/universal_models.py`): Domain-agnostic data structures
2. **Configuration Management** (`config/universal_config.py`, `agents/core/simple_config_manager.py`): Runtime configuration
3. **Learned Domain Configurations** (generated by Domain Intelligence Agent)
4. **Performance Feedback Loops** (adaptive based on query metrics)

**Universal RAG Flow**: Content Analysis → Discovered Characteristics → Dynamic Configuration → Agent Processing

**Pre-commit Hook Enforcement**: The repository enforces domain bias detection via `scripts/hooks/pre-commit-domain-bias-check.sh`:
- Detects hardcoded domain categories (technical, legal, medical, etc.)
- Identifies domain classification logic that violates universal principles  
- Validates content-agnostic patterns across all agents
- Ensures configuration adapts to discovered content properties, not predetermined domains

### Agent Development Patterns (CRITICAL)

**Agents are stateless** and use PydanticAI framework patterns:
- **PydanticAI Integration**: All agents use PydanticAI with AsyncAzureOpenAI clients
- **Universal Models**: Use `agents/core/universal_models.py` for domain-agnostic data structures
- **Azure Service Integration**: Real Azure services (OpenAI, Cosmos DB, Cognitive Search) via infrastructure layer
- **Query Generation Pattern**: Specialized agents for different query types (Gremlin, Search, Analysis)
- **Type Safety**: Pydantic models for all agent inputs/outputs with validation

### Clean Architecture Enforcement
- **Layer Separation**: Agents depend on infrastructure, never the reverse
- **Real Azure Services**: No mocks in testing - all tests use actual Azure infrastructure
- **Error Handling**: Comprehensive Azure service retry logic and graceful degradation
- **Azure Authentication**: Always use `DefaultAzureCredential` for unified authentication
- **Environment Management**: Multi-environment support (development/staging/production) with automatic synchronization

## Development Commands

### Essential Development Workflow
```bash
# Core development cycle (run from azure-maintie-rag/)
make setup              # Full project setup (backend + frontend)  
make dev                # Start backend API (8000) and frontend UI (5174)
make health             # Comprehensive Azure service health check
make clean              # Clean sessions with log replacement

# Environment synchronization (critical for Azure services)
./scripts/deployment/sync-env.sh development    # Switch to development + sync backend
./scripts/deployment/sync-env.sh staging       # Switch to staging + sync backend  
make sync-env                                   # Sync backend with current azd environment

# Agent development workflow
cd agents/domain_intelligence && python agent.py    # Test Domain Intelligence Agent
cd agents/knowledge_extraction && python agent.py  # Test Knowledge Extraction Agent  
cd agents/universal_search && python agent.py      # Test Universal Search Agent
```

### Data Processing Pipeline
```bash
# Full pipeline commands (use these for end-to-end workflow)
make data-prep-full     # Complete data processing pipeline (scripts/dataflow/00_full_pipeline.py)
make data-upload        # Upload documents & create chunks
make knowledge-extract  # Extract entities & relationships (02_knowledge_extraction.py)
make query-demo         # Query pipeline demonstration (10_query_pipeline.py)
make unified-search-demo # Tri-modal search demonstration (07_unified_search.py)
make full-workflow-demo # End-to-end agent orchestration demonstration

# Individual dataflow scripts for development
python scripts/dataflow/00_check_azure_state.py     # Verify Azure service health
python scripts/dataflow/01_data_ingestion.py        # Document ingestion
python scripts/dataflow/01a_azure_storage.py        # Azure Blob Storage operations
python scripts/dataflow/01b_azure_search.py         # Azure Cognitive Search indexing
python scripts/dataflow/02_knowledge_extraction.py  # Knowledge Extraction Agent
python scripts/dataflow/03_cosmos_storage.py        # Graph storage in Cosmos DB
python scripts/dataflow/07_unified_search.py        # Universal Search Agent
python scripts/dataflow/12_query_generation_showcase.py # Query Generation Agents demo
```

### Testing Commands
```bash
# Testing strategy (tests use real Azure services - no mocks)
pytest                  # All tests with automatic asyncio handling (pytest.ini configured)
pytest -m unit          # Unit tests for agent logic and universal models
pytest -m integration   # Integration tests with real Azure services
pytest -m azure_validation # Azure service health validation
pytest -m performance   # SLA compliance and performance tests

# Specific test categories
pytest tests/test_universal_content_processing.py    # Universal RAG content processing
pytest tests/test_knowledge_graph_intelligence.py   # Knowledge extraction and graph tests
pytest tests/test_enterprise_deployment.py         # Enterprise deployment validation
pytest tests/test_advanced_search_discovery.py     # Multi-modal search testing

# Development testing patterns
pytest -v --tb=short    # Verbose output with short tracebacks
pytest -k "test_name"   # Run specific test pattern
pytest --collect-only   # Show available tests without running
pytest -x              # Stop on first failure (useful for debugging)
```

### Individual Service Development
```bash
# Backend development (FastAPI with real Azure services)
uvicorn api.main:app --reload --host 0.0.0.0 --port 8000    # Development server
python -m api.main                                           # Alternative startup

# Frontend development (React 19.1.0 + TypeScript 5.8.3 + Vite 7.0.4)
cd frontend/
npm run dev             # Start Vite dev server (localhost:5174)
npm run build           # Production build with TypeScript compilation
npm run lint            # Run ESLint with React/TypeScript rules
npx tsc --noEmit        # TypeScript type checking without compilation
npm run preview         # Preview production build locally

# Code quality commands
black . --check                    # Python code formatting check
isort . --check-only               # Python import organization check
cd frontend && npm run lint        # Frontend linting
./scripts/hooks/pre-commit-domain-bias-check.sh  # Domain bias validation
```

### Azure Deployment
```bash
# Complete infrastructure deployment with Azure Developer CLI
azd up                  # Deploy complete Azure infrastructure (9 services)
azd env select production && azd up  # Deploy to production environment

# Environment management
azd env new development && azd up    # Create and deploy development environment
azd env new staging && azd up        # Create and deploy staging environment
azd env select <environment>         # Switch between environments

# Infrastructure automation
./scripts/deployment/setup-environments.sh     # Setup all environments
./scripts/deployment/azure_deployment_helper.sh # Deployment assistance
./scripts/deployment/test-infrastructure.sh    # Validate infrastructure

# CI/CD Pipeline setup
azd pipeline config     # Automatic GitHub Actions CI/CD setup
```

## Technology Stack

### Backend Architecture
- **Python 3.11+** with async/await patterns throughout
- **FastAPI** with uvicorn for API endpoints and streaming
- **PydanticAI 0.1.0+** for multi-agent framework with type safety
- **Azure OpenAI** for LLM operations with AsyncAzureOpenAI client
- **Azure Cognitive Search** for vector search (1536D vectors)
- **Azure Cosmos DB** (Gremlin API) for knowledge graph storage
- **Azure ML** for GNN training and inference
- **Azure Blob Storage** for document management
- **Azure Key Vault** for secrets management
- **PyTorch + torch-geometric** for graph neural networks

### Frontend Architecture
- **React 19.1.0** with TypeScript 5.8.3
- **Vite 7.0.4** for build tooling and development
- **Axios 1.10.0** for HTTP requests
- **Server-Sent Events** for real-time progress updates

### Code Quality & Testing
- **Black** formatter (line length 88, configured in pyproject.toml)
- **isort** for import organization (black profile, first-party packages: agents, api, infrastructure, config)
- **ESLint 9.30.1** for TypeScript/React code quality with typescript-eslint 8.35.1
- **pytest 7.4.0+** with asyncio auto mode and comprehensive test discovery
- **Pre-commit hooks** for domain bias detection (no hardcoded domain assumptions)
- **MyPy** for type checking (optional dependency)
- **Real Azure Services Testing** - no mocks, comprehensive integration validation

## Configuration & Environment Management

### Environment Configuration
- `config/environments/development.env` - Development Azure settings
- `config/environments/staging.env` - Staging Azure settings  
- `config/azure_settings.py` - Azure service settings with validation
- `config/universal_config.py` - Universal RAG configuration
- `agents/core/simple_config_manager.py` - Simple configuration management
- Root level: `pyproject.toml`, `pytest.ini` for project tooling

**Environment Synchronization**:
- Configuration automatically syncs with `azd` environment selection
- Use `./scripts/deployment/sync-env.sh <environment>` to switch and sync
- Environment variables managed through `USE_MANAGED_IDENTITY` setting
- Multi-environment support: development, staging, production with appropriate Azure SKUs

### Azure Service Authentication
- Uses **DefaultAzureCredential** for unified authentication across all services
- Supports managed identity (production) and CLI authentication (development)
- No API keys or connection strings in code - all through Azure authentication

## Testing & Validation Strategy

### Testing Architecture
- **Test Organization**: Tests organized by markers - unit, integration, azure_validation, performance  
- **Real Azure Services**: Tests use actual Azure services, not mocks (see `tests/conftest.py`)
- **Universal Testing**: Domain-agnostic test patterns using `sample_documents` fixture with multiple domains
- **Agent Testing**: PydanticAI agent integration tests with real Azure OpenAI backends
- **Performance Testing**: SLA compliance testing with performance monitoring fixtures
- **Test Discovery**: Automatic async handling via `pytest.ini` with `asyncio_mode = auto`

### Performance Monitoring
- **Target Metrics**: Sub-3-second query processing (currently 0.8-1.8s uncached)
- **Cache Performance**: 60% cache hit rate (reduces to ~50ms response time)
- **Extraction Accuracy**: 85% relationship extraction accuracy
- **Concurrent Users**: 100+ concurrent users supported

### Session Management Pattern
- Clean session replacement (no log accumulation)
- Unique session timestamps for tracking
- Performance metrics capture in `logs/performance.log`
- Azure status monitoring in `logs/azure_status.log`

## Code Quality & Validation

### Pre-commit Validation Workflow
```bash
# Run before committing (required)
black . --check                                         # Code formatting check
isort . --check-only                                    # Import organization check
cd frontend && npm run lint                             # Frontend linting  
./scripts/hooks/pre-commit-domain-bias-check.sh        # Universal RAG domain bias validation
pytest -m unit                                         # Quick unit tests
```

### Service Validation Commands
```bash
make health                    # Full system health check
make azure-status             # Azure infrastructure status
make session-report           # Current session metrics
```

## Key File Structure

### Core Architecture Components
```
agents/                          # Multi-agent system (PydanticAI)
├── core/                        # Core infrastructure
│   ├── universal_models.py      # Universal data models for domain-agnostic processing
│   ├── constants.py             # Zero-hardcoded-values constants
│   ├── simple_config_manager.py # Simple configuration management
│   ├── universal_deps.py        # Universal dependencies
│   └── __init__.py              # Module initialization
├── domain_intelligence/         # Domain analysis agent
│   ├── agent.py                 # Domain Intelligence Agent with Azure OpenAI integration
│   └── __init__.py
├── knowledge_extraction/        # Entity/relationship extraction agent
│   ├── agent.py                 # Knowledge Extraction Agent with Cosmos DB integration
│   └── __init__.py
├── universal_search/            # Tri-modal search agent
│   ├── agent.py                 # Universal Search Agent with multi-modal search
│   └── __init__.py
├── shared/                      # Common agent utilities
│   ├── query_tools.py           # Query processing tools
│   └── __init__.py
├── examples/                    # Agent workflow demonstrations
└── orchestrator.py             # Multi-agent orchestration

infrastructure/                  # Azure service clients (real implementation)
├── azure_openai/               # LLM operations with AsyncAzureOpenAI
├── azure_search/               # Vector search with Azure Cognitive Search
├── azure_cosmos/               # Graph database with Gremlin API
├── azure_storage/              # Blob storage for document management
├── azure_ml/                   # GNN training and inference
├── azure_auth/                 # Azure authentication utilities
├── azure_monitoring/           # Application Insights monitoring
├── utilities/                  # Common infrastructure utilities
└── prompt_workflows/           # Jinja2 templates for universal prompt engineering

config/                         # Environment-based configuration
├── universal_config.py         # Universal RAG configuration
├── azure_settings.py          # Azure service settings
├── timeouts.py                 # Service timeout configurations
├── settings.py                 # Application settings
└── environments/               # Environment-specific settings (.env files)

api/                            # FastAPI endpoints with streaming
├── main.py                     # FastAPI application entry point
├── endpoints/                  # Individual API endpoints
├── models/                     # API request/response models
└── streaming/                  # Server-sent events for real-time updates

tests/                          # Real Azure services testing (no mocks)
├── test_universal_content_processing.py    # Universal RAG processing tests
├── test_knowledge_graph_intelligence.py   # Knowledge extraction and graph tests
├── test_enterprise_deployment.py         # Enterprise deployment validation
├── test_advanced_search_discovery.py     # Multi-modal search testing
└── conftest.py                           # Real Azure services fixtures

scripts/                        # Development and deployment automation
├── dataflow/                   # Complete data processing pipeline
│   ├── 00_full_pipeline.py     # Complete pipeline orchestration
│   ├── 02_knowledge_extraction.py # Knowledge Extraction Agent processing
│   ├── 07_unified_search.py    # Universal Search Agent demonstration
│   ├── 12_query_generation_showcase.py # Query Generation Agents demo
│   └── demo_full_workflow.py   # End-to-end workflow demonstration
├── hooks/                      # Pre-commit validation hooks
│   └── pre-commit-domain-bias-check.sh # Universal RAG domain bias detection
└── deployment/                 # Azure deployment automation

frontend/                       # React TypeScript frontend with streaming
├── package.json                # Dependencies (React 19.1.0, TypeScript 5.8.3, Vite 7.0.4)
├── src/                        # Application source code
│   ├── components/             # React components (chat, domain, workflow, shared)
│   ├── hooks/                  # Custom React hooks (useUniversalRAG, useWorkflowStream)
│   ├── services/               # API communication and streaming
│   └── types/                  # TypeScript type definitions
└── public/                     # Static assets

data/                           # Test data and processing
├── raw/Programming-Language/   # Real test corpus (82 Sebesta textbook files)
└── processed/                  # Processed data outputs

infra/                         # Azure Infrastructure as Code
├── main.bicep                  # Infrastructure entry point
├── modules/                    # Modular Bicep templates
└── main.parameters.json        # Environment parameters
```

## Current Development Context

### Active Branch: `feature/universal-agents-clean`
Focus on Universal RAG philosophy with zero domain bias and PydanticAI integration.

### Development Priorities
1. **Universal RAG Philosophy**: No hardcoded domain categories - discover content characteristics dynamically
2. **PydanticAI Integration**: Type-safe multi-agent communication with real Azure OpenAI backends
3. **Real Azure Services**: Comprehensive integration testing with actual Azure infrastructure
4. **Query Generation Pattern**: SQL-style agent specialization for different query types
5. **Domain-Agnostic Design**: All patterns must work universally across any domain

### Key Constraints
- **Universal Design**: Never assume domain types - analyze content properties instead
- **Security**: Never commit secrets - use Azure Key Vault and DefaultAzureCredential exclusively  
- **Real Services**: Test with actual Azure services, never mocks
- **Type Safety**: Use Pydantic models for all agent interfaces and data structures
- **Domain Bias Detection**: Pre-commit hooks enforce zero domain assumptions

## Critical Development Patterns

### Session Management Pattern
- **Clean Session Replacement**: All make commands create unique session IDs and replace previous logs
- **No Log Accumulation**: System automatically cleans and replaces session data
- **Enterprise Reporting**: Each session generates comprehensive reports in `logs/session_report.md`
- **Performance Tracking**: Metrics captured in `logs/performance.log` and `logs/azure_status.log`

### Make Command Architecture
The Makefile implements enterprise session tracking with clean output replacement:
- Each command starts with `$(call start_clean_session)` to create unique session
- Commands capture Azure status, performance metrics, and detailed outputs
- Session reports provide comprehensive status for enterprise workflows
- Use `make session-report` to view current session status

### Environment Synchronization Critical Workflow
```bash
# CRITICAL: Always sync environment before deployment
./scripts/deployment/sync-env.sh <environment>  # Switches azd environment AND syncs backend
make sync-env                                   # Syncs backend with current azd environment

# This ensures backend configuration matches azd environment selection
# Supports development, staging, and production environments with appropriate Azure SKUs
```

### Domain-Agnostic Development Pattern
```bash
# Universal RAG development workflow - no domain assumptions
python scripts/dataflow/12_query_generation_showcase.py  # Query agents demo
./scripts/hooks/pre-commit-domain-bias-check.sh         # Validate no domain bias
pytest tests/test_universal_content_processing.py       # Universal processing tests

# Content analysis approach (NOT domain classification)
# 1. Analyze vocabulary_complexity, concept_density, relationship_patterns
# 2. Adapt parameters based on measured properties  
# 3. Use universal models that work for ANY domain
# 4. Let Domain Intelligence Agent DISCOVER characteristics
```

## Navigation Commands

When working in this workspace, always navigate to the correct project:
```bash
# For primary development (Azure Universal RAG)
cd azure-maintie-rag/

# For vocabulary scraper project
cd fireflyau-vocab-scraper/

# For simplified RAG template
cd universal-rag-azure/
```

The azure-maintie-rag/ directory is the primary focus and contains the production-ready system with all the features described above.